<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gestion Caravane Don de Sang - ENSEM CIDH</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-dark: #3E2B5F;
            --primary-light: #6B4FA0;
            --accent-light: #9B7FC4;
            --accent-lavender: #E8DFF5;
            --red-accent: #E63946;
            --green-accent: #2A9D8F;
            --neutral-dark: #1F1F1F;
            --neutral-light: #F8F9FA;
            --border-color: #D9D3E3;
            --sidebar-width: 280px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            min-height: 100vh;
            color: var(--neutral-dark);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: var(--sidebar-width);
            background: rgba(62, 43, 95, 0.98);
            backdrop-filter: blur(10px);
            padding: 30px 20px;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 40px;
            border-right: 1px solid rgba(155, 127, 196, 0.3);
            height: 100vh;
            position: sticky;
            top: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .logo-section img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: contain;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
        }

        .logo-section h1 {
            font-size: 16px;
            color: white;
            line-height: 1.2;
            font-weight: 700;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            padding: 14px 16px;
            background: rgba(155, 127, 196, 0.1);
            border: 2px solid transparent;
            border-left: 3px solid transparent;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-item:hover, .nav-item:active {
            background: rgba(155, 127, 196, 0.25);
            color: white;
        }

        .nav-item.active {
            background: rgba(230, 57, 70, 0.15);
            border-left-color: var(--red-accent);
            color: white;
            box-shadow: inset 0 0 10px rgba(230, 57, 70, 0.1);
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 0;
        }

        /* HEADER */
        .header {
            background: white;
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--primary-dark);
        }

        .header h2 {
            font-size: 24px;
            color: var(--primary-dark);
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        /* BOUTONS */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--red-accent), #ff5f6b);
            color: white;
            box-shadow: 0 4px 15px rgba(230, 57, 70, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(230, 57, 70, 0.4);
        }

        .btn-secondary {
            background: var(--neutral-light);
            color: var(--primary-dark);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--accent-lavender);
            border-color: var(--accent-light);
        }

        /* ZONE DE CONTENU */
        .content-area {
            flex: 1;
            padding: 30px;
            background: linear-gradient(to bottom, #f5f3f9 0%, #ffffff 50%);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .tab-content.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* CARTES */
        .card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 2px 15px rgba(62, 43, 95, 0.08);
            border: 1px solid var(--border-color);
            margin-bottom: 25px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card h3 {
            color: var(--primary-dark);
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .card h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--red-accent);
            border-radius: 2px;
        }

        /* TABLEAUX */
        .table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        thead tr {
            background: linear-gradient(90deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            color: white;
        }

        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 14px;
        }

        th { font-weight: 600; }
        
        tbody tr:hover { background: var(--accent-lavender); }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-present { background: rgba(42, 157, 143, 0.15); color: var(--green-accent); }
        .status-absent { background: rgba(230, 57, 70, 0.15); color: var(--red-accent); }
        .status-pending { background: rgba(155, 127, 196, 0.15); color: var(--primary-light); }

        /* INPUTS & FORMULAIRES */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; color: var(--primary-dark); font-weight: 600; font-size: 13px; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-family: inherit;
            font-size: 16px;
        }

        /* STATS GRIDS */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

        .stat-card {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-light) 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }
        .stat-number { font-size: 36px; font-weight: 700; margin: 5px 0; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        /* --- NOUVEAU : STYLE BARRE PROGRESSION --- */
        .progress-section {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(62, 43, 95, 0.08);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            color: var(--primary-dark);
            font-weight: 700;
        }
        .progress-container {
            background: #E8DFF5;
            border-radius: 20px;
            height: 35px;
            width: 100%;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
        }
        .progress-bar {
            background: linear-gradient(90deg, #E63946, #ff5f6b);
            height: 100%;
            width: 0%; /* JS va changer √ßa */
            border-radius: 20px;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 15px;
            box-shadow: 2px 0 10px rgba(230, 57, 70, 0.4);
        }
        .progress-text {
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            white-space: nowrap;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 25px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .modal-header {
            font-size: 20px; font-weight: 700; color: var(--primary-dark);
            margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;
        }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }

        /* --- RESPONSIVE MOBILE --- */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                box-shadow: 5px 0 15px rgba(0,0,0,0.3);
            }
            .sidebar.active { transform: translateX(280px); }
            .menu-toggle { display: block; }
            .sidebar-overlay {
                display: none;
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 99;
            }
            .sidebar-overlay.active { display: block; }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
                padding: 15px;
            }
            .header-left { justify-content: space-between; width: 100%; }
            .header-actions { flex-direction: column; width: 100%; }
            .header-actions button, .header-actions input, .header-actions div { width: 100% !important; }
            .content-area { padding: 15px; }
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .card { padding: 15px; }
            .btn { width: 100%; margin-bottom: 5px; }
            .card-header { flex-direction: column; align-items: stretch; gap: 15px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

        <div class="sidebar" id="sidebar">
            <div>
                <div class="logo-section">
                    <img src="https://agi-prod-file-upload-public-main-use1.s3.amazonaws.com/553616c3-1f4f-49ec-a23d-3e9db473cf4d" alt="ENSEM CIDH">
                    <h1>ENSEM ELKHIR</h1>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchTab('donneurs'); toggleSidebar()">
                    <span class="nav-icon">üë•</span>
                    <span>Donneurs</span>
                </div>
                <div class="nav-item" onclick="switchTab('comite'); toggleSidebar()">
                    <span class="nav-icon">üìã</span>
                    <span>Comit√©</span>
                </div>
                <div class="nav-item" onclick="switchTab('suivi'); toggleSidebar()">
                    <span class="nav-icon">‚úÖ</span>
                    <span>Suivi Jour J</span>
                </div>
                <div class="nav-item" onclick="switchTab('stats'); toggleSidebar()">
                    <span class="nav-icon">üìä</span>
                    <span>Statistiques</span>
                </div>
            </nav>
        </div>

        <div class="main-content">
            <div class="header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2 id="page-title">Gestion des Donneurs</h2>
                </div>
                <div class="header-actions">
                    <div style="display: flex; gap: 5px; align-items: center; flex: 1;">
                        <input type="text" id="search-input" placeholder="üîç Rechercher..." style="min-width: 200px;">
                    </div>
                    
                    <input type="file" id="backup-input" accept=".json" style="display: none;" onchange="importJSONBackup(event)">
                    <button class="btn btn-secondary" onclick="document.getElementById('backup-input').click()">üìÇ Restaurer</button>
                    <button class="btn btn-secondary" onclick="openModal('export')">üì• Exporter</button>
                    <button class="btn btn-primary" onclick="openModal('add')">‚ûï Ajouter</button>
                </div>
            </div>

            <div class="content-area">
                <div class="tab-content active" id="donneurs">
                    <div class="card">
                        <div class="card-header">
                            <h3>Liste Compl√®te (Tous)</h3>
                            <button class="btn btn-secondary" onclick="openModal('import')">üìÇ Importer Excel</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Nom</th>
                                        <th>T√©l√©phone</th>
                                        <th>Cr√©neau</th>
                                        <th>N¬∞ Pr√©l√®vement</th>
                                        <th>√âcole</th>
                                        <th>Fili√®re</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="donneurs-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="comite">
                    <div class="card">
                        <div class="card-header">
                            <h3>Comit√© Organisateur</h3>
                            <button class="btn btn-primary" onclick="openModal('add-comite')">‚ûï Ajouter Membre</button>
                        </div>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nom</th>
                                        <th>R√¥le</th>
                                        <th>Fili√®re</th>
                                        <th>Pr√©sence</th>
                                        <th>Justification</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="comite-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="suivi">
                    <div class="grid-2">
                        <div class="stat-card">
                            <div class="stat-label">Inscrits (Avec N¬∞)</div>
                            <div class="stat-number" id="stat-inscrits">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Pr√©sents Confirm√©s</div>
                            <div class="stat-number" id="stat-presents">0</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 20px;">
                        <h3>Pointage Temps R√©el (Seulement avec N¬∞ Pr√©l√®vement)</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>N¬∞</th>
                                        <th>Nom</th>
                                        <th>Cr√©neau</th>
                                        <th>√âtat</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="suivi-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="tab-content" id="stats">
                    <div class="progress-section">
                        <div class="progress-header">
                            <span>ü©∏ Objectif Poches</span>
                            <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 12px;" onclick="changeObjectif()">‚öôÔ∏è Modifier</button>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar" id="progress-fill">
                                <span class="progress-text" id="progress-label">0 / 200 (0%)</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid-3">
                        <div class="stat-card">
                            <div class="stat-label">Total Inscrits (N¬∞)</div>
                            <div class="stat-number" id="total-inscrits">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Pr√©sents</div>
                            <div class="stat-number" id="total-presents">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Taux Pr√©sence</div>
                            <div class="stat-number" id="taux-presence">0%</div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 20px;">
                        <h3>Distribution par Cr√©neau (Seulement avec N¬∞)</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Cr√©neau</th>
                                        <th>Inscrits</th>
                                        <th>Pr√©sents</th>
                                        <th>Absence</th>
                                    </tr>
                                </thead>
                                <tbody id="stats-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-add">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ûï Ajouter Donneur</span>
                <button class="modal-close" onclick="closeModal('add')">‚úï</button>
            </div>
            <form onsubmit="addDonneur(event)">
                <div class="input-group">
                    <label>Nom Complet</label>
                    <input type="text" id="form-nom" required>
                </div>
                <div class="input-group">
                    <label>T√©l√©phone</label>
                    <input type="tel" id="form-tel" required>
                </div>
                <div class="input-group">
                    <label>Cr√©neau</label>
                    <select id="form-creneau" required>
                        <option value="">Choisir...</option>
                        <option value="09h00 ‚Äì 10h00">09h00 ‚Äì 10h00</option>
                        <option value="10h00 ‚Äì 11h00">10h00 ‚Äì 11h00</option>
                        <option value="11h00 ‚Äì 12h00">11h00 ‚Äì 12h00</option>
                        <option value="12h00 - 13h00">12h00 - 13h00</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>N¬∞ Pr√©l√®vement</label>
                    <input type="text" id="form-numPrelevement" placeholder="Laisser vide si pas encore donn√©">
                </div>
                <div class="grid-2" style="gap: 10px;">
                    <div class="input-group">
                        <label>√âcole</label>
                        <select id="form-ecole" required>
                            <option value="ENSEM">ENSEM</option>
                            <option value="ENS">ENS</option>
                            <option value="ESITH">ESITH</option>
                            <option value="EHTP">EHTP</option>
                            <option value="EST">EST</option>
                            <option value="ISEM">ISEM</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Fili√®re</label>
                        <input type="text" id="form-filiere" placeholder="ex: G.Info">
                    </div>
                </div>
                <div class="input-group">
                    <label>Remarques</label>
                    <textarea id="form-remarques" placeholder="Notes..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ajouter Donneur</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-add-comite">
        <div class="modal-content">
            <div class="modal-header">
                <span>‚ûï Ajouter Membre</span>
                <button class="modal-close" onclick="closeModal('add-comite')">‚úï</button>
            </div>
            <form onsubmit="addComite(event)">
                <div class="input-group"><label>Nom</label><input type="text" id="comite-nom" required></div>
                <div class="input-group"><label>R√¥le</label><input type="text" id="comite-role" required></div>
                <div class="input-group"><label>Fili√®re</label><input type="text" id="comite-filiere" required></div>
                <div class="input-group"><label>Pr√©sence</label>
                    <select id="comite-present"><option value="true">Pr√©sent</option><option value="false">Absent</option></select>
                </div>
                <div class="input-group"><label>Justification</label><input type="text" id="comite-justif"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Ajouter</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-edit-comite">
        <div class="modal-content">
            <div class="modal-header"><span>‚úèÔ∏è Modifier</span><button class="modal-close" onclick="closeModal('edit-comite')">‚úï</button></div>
            <form onsubmit="saveComite(event)">
                <div class="input-group"><label>Nom</label><input type="text" id="edit-comite-nom" required></div>
                <div class="input-group"><label>R√¥le</label><input type="text" id="edit-comite-role" required></div>
                <div class="input-group"><label>Fili√®re</label><input type="text" id="edit-comite-filiere" required></div>
                <div class="input-group"><label>Pr√©sence</label>
                    <select id="edit-comite-present"><option value="true">Pr√©sent</option><option value="false">Absent</option></select>
                </div>
                <div class="input-group"><label>Justification</label><input type="text" id="edit-comite-justif"></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sauvegarder</button>
            </form>
        </div>
    </div>

    <div class="modal" id="modal-export">
        <div class="modal-content">
            <div class="modal-header"><span>üì• Exporter</span><button class="modal-close" onclick="closeModal('export')">‚úï</button></div>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="exportCSV()">üìä CSV (Donneurs)</button>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="exportPDF()">üìÑ PDF (Onglet Actif)</button>
            <button class="btn btn-secondary" style="width: 100%;" onclick="exportJSON()">üìã Sauvegarde Compl√®te (JSON)</button>
        </div>
    </div>

    <div class="modal" id="modal-import">
        <div class="modal-content">
            <div class="modal-header"><span>üìÇ Importer Excel</span><button class="modal-close" onclick="closeModal('import')">‚úï</button></div>
            <input type="file" id="import-file" accept=".xlsx,.xls,.csv" style="margin-bottom: 20px; width: 100%;">
            <button class="btn btn-primary" style="width: 100%;" onclick="importExcel()">Importer</button>
        </div>
    </div>

    <div class="modal" id="modal-edit">
        <div class="modal-content">
            <div class="modal-header"><span>‚úèÔ∏è Modifier Donneur</span><button class="modal-close" onclick="closeModal('edit')">‚úï</button></div>
            <form onsubmit="saveDonneur(event)">
                <div class="input-group"><label>Nom</label><input type="text" id="edit-nom" required></div>
                <div class="input-group"><label>Tel</label><input type="tel" id="edit-tel" required></div>
                <div class="input-group"><label>Cr√©neau</label>
                    <select id="edit-creneau" required>
                        <option value="09h00 ‚Äì 10h00">09h00 ‚Äì 10h00</option><option value="10h00 ‚Äì 11h00">10h00 ‚Äì 11h00</option>
                        <option value="11h00 ‚Äì 12h00">11h00 ‚Äì 12h00</option><option value="12h00 - 13h00">12h00 - 13h00</option>
                    </select>
                </div>
                <div class="input-group"><label>N¬∞ Pr√©l√®vement</label><input type="text" id="edit-numPrelevement" placeholder="P001"></div>
                <div class="grid-2" style="gap:10px">
                    <div class="input-group"><label>√âcole</label><select id="edit-ecole" required><option value="ENSEM">ENSEM</option><option value="ENS">ENS</option><option value="ESITH">ESITH</option><option value="EHTP">EHTP</option><option value="EST">EST</option><option value="ISEM">ISEM</option></select></div>
                    <div class="input-group"><label>Fili√®re</label><input type="text" id="edit-filiere"></div>
                </div>
                <div class="input-group"><label>Remarques</label><textarea id="edit-remarques"></textarea></div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Sauvegarder</button>
            </form>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        // DONNEES INITIALES (Exemple)
        let donneurs = [
            { id: 1, nom: "Exemple Sans N¬∞", tel: "0600000000", creneau: "09h00 ‚Äì 10h00", numPrelevement: "", ecole: "ENSEM", filiere: "G.Info", remarques: "", status: "absent" },
            { id: 2, nom: "Exemple Avec N¬∞", tel: "0600000001", creneau: "09h00 ‚Äì 10h00", numPrelevement: "P001", ecole: "ENSEM", filiere: "G.Indus", remarques: "", status: "present" }
        ];
        let comite = [
            { id: 1, nom: "Responsable", role: "Chef Projet", filiere: "G.Info", present: true, justification: "" }
        ];
        let editingId = null;
        let editingComiteId = null;
        let objectif = 200; // OBJECTIF PAR DEFAUT

        // RESPONSIVE
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay').classList.toggle('active');
        }

        // NAVIGATION
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            const titles = { donneurs: 'Donneurs', comite: 'Comit√©', suivi: 'Suivi Jour J', stats: 'Statistiques' };
            document.getElementById('page-title').textContent = titles[tabName];

            if (tabName === 'donneurs') renderDonneurs();
            if (tabName === 'comite') renderComite();
            if (tabName === 'suivi') renderSuivi();
            if (tabName === 'stats') renderStats();
        }

        // UTILS
        function hasNum(d) {
            return d.numPrelevement && d.numPrelevement.toString().trim() !== '';
        }

        // RENDU DONNEURS
        function renderDonneurs() {
            const tbody = document.getElementById('donneurs-table');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const filtered = donneurs.filter(d => d.nom.toLowerCase().includes(searchTerm));
            
            tbody.innerHTML = filtered.map((d, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td><strong>${d.nom}</strong></td>
                    <td>${d.tel}</td>
                    <td>${d.creneau}</td>
                    <td><span style="font-weight:bold; color:${hasNum(d)?'var(--primary-dark)':'#ccc'}">${d.numPrelevement || 'Aucun'}</span></td>
                    <td>${d.ecole}</td>
                    <td>${d.filiere}</td>
                    <td><span class="status-badge status-${d.status}">${d.status === 'present' ? 'Pr√©sent' : 'Absent'}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="padding:5px 8px;" onclick="editDonneur(${d.id})">‚úèÔ∏è</button>
                        <button class="btn btn-secondary" style="padding:5px 8px; color:red;" onclick="deleteDonneur(${d.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        document.getElementById('search-input').addEventListener('keyup', renderDonneurs);

        // RENDU COMITE
        function renderComite() {
            const tbody = document.getElementById('comite-table');
            tbody.innerHTML = comite.map(c => `
                <tr>
                    <td><strong>${c.nom}</strong></td>
                    <td>${c.role}</td>
                    <td>${c.filiere || '-'}</td>
                    <td><span class="status-badge ${c.present ? 'status-present' : 'status-absent'}">${c.present ? 'Pr√©sent' : 'Absent'}</span></td>
                    <td>${c.justification || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" style="padding:5px 8px;" onclick="editComite(${c.id})">‚úèÔ∏è</button>
                        <button class="btn btn-secondary" style="padding:5px 8px; color:red;" onclick="deleteComite(${c.id})">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // SUIVI JOUR J
        function renderSuivi() {
            const validDonneurs = donneurs.filter(hasNum);
            const stats = { presents: validDonneurs.filter(d=>d.status==='present').length };
            
            document.getElementById('stat-inscrits').textContent = validDonneurs.length;
            document.getElementById('stat-presents').textContent = stats.presents;
            
            const sorted = validDonneurs.sort((a,b) => a.creneau.localeCompare(b.creneau));
            document.getElementById('suivi-table').innerHTML = sorted.map(d => `
                <tr>
                    <td><strong>${d.numPrelevement}</strong></td>
                    <td>${d.nom}</td>
                    <td>${d.creneau}</td>
                    <td><span class="status-badge status-${d.status}">${d.status === 'present' ? '‚úì Pr√©sent' : '‚úó Absent'}</span></td>
                    <td><button class="btn btn-secondary" onclick="toggleStatus(${d.id})">${d.status === 'present' ? 'Marquer Absent' : 'Marquer Pr√©sent'}</button></td>
                </tr>`).join('');
        }
        function toggleStatus(id) {
            const d = donneurs.find(x => x.id === id);
            if(d) { d.status = d.status === 'present' ? 'absent' : 'present'; renderSuivi(); }
        }

        // STATISTIQUES (AVEC BARRE PROGRESSION)
        function changeObjectif() {
            const newObj = prompt("Quel est l'objectif de poches ?", objectif);
            if(newObj && !isNaN(newObj)) { objectif = parseInt(newObj); renderStats(); }
        }

        function renderStats() {
            const validDonneurs = donneurs.filter(hasNum);
            const p = validDonneurs.filter(d=>d.status==='present').length;
            
            document.getElementById('total-inscrits').textContent = validDonneurs.length;
            document.getElementById('total-presents').textContent = p;
            document.getElementById('taux-presence').textContent = validDonneurs.length ? Math.round((p/validDonneurs.length)*100)+'%' : '0%';
            
            // Mise √† jour Barre
            const percentage = Math.min(Math.round((p / objectif) * 100), 100);
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-label').textContent = `${p} / ${objectif} Poches (${percentage}%)`;

            const cr = {};
            validDonneurs.forEach(d => {
                if(!cr[d.creneau]) cr[d.creneau] = {t:0, p:0, a:0};
                cr[d.creneau].t++;
                d.status==='present' ? cr[d.creneau].p++ : cr[d.creneau].a++;
            });
            document.getElementById('stats-table').innerHTML = Object.entries(cr).map(([k,v]) => `
                <tr><td><strong>${k}</strong></td><td>${v.t}</td><td><span class="status-badge status-present">${v.p}</span></td><td><span class="status-badge status-absent">${v.a}</span></td></tr>
            `).join('');
        }

        // LOGIQUES AJOUT / MODIF
        function addComite(e) {
            e.preventDefault();
            comite.push({
                id: Math.max(...comite.map(c => c.id || 0), 0) + 1,
                nom: document.getElementById('comite-nom').value,
                role: document.getElementById('comite-role').value,
                filiere: document.getElementById('comite-filiere').value,
                present: document.getElementById('comite-present').value === 'true',
                justification: document.getElementById('comite-justif').value
            });
            closeModal('add-comite'); e.target.reset(); renderComite();
        }

        function editComite(id) {
            editingComiteId = id; const m = comite.find(c => c.id === id);
            if (m) {
                document.getElementById('edit-comite-nom').value = m.nom;
                document.getElementById('edit-comite-role').value = m.role;
                document.getElementById('edit-comite-filiere').value = m.filiere;
                document.getElementById('edit-comite-present').value = m.present;
                document.getElementById('edit-comite-justif').value = m.justification;
                openModal('edit-comite');
            }
        }
        function saveComite(e) {
            e.preventDefault(); const m = comite.find(c => c.id === editingComiteId);
            if (m) {
                m.nom = document.getElementById('edit-comite-nom').value;
                m.role = document.getElementById('edit-comite-role').value;
                m.filiere = document.getElementById('edit-comite-filiere').value;
                m.present = document.getElementById('edit-comite-present').value === 'true';
                m.justification = document.getElementById('edit-comite-justif').value;
                closeModal('edit-comite'); renderComite();
            }
        }
        function deleteComite(id) { if(confirm('Supprimer ?')) { comite = comite.filter(c => c.id !== id); renderComite(); } }

        function addDonneur(e) {
            e.preventDefault();
            donneurs.push({
                id: Math.max(...donneurs.map(d => d.id), 0) + 1,
                nom: document.getElementById('form-nom').value,
                tel: document.getElementById('form-tel').value,
                creneau: document.getElementById('form-creneau').value,
                numPrelevement: document.getElementById('form-numPrelevement').value,
                ecole: document.getElementById('form-ecole').value,
                filiere: document.getElementById('form-filiere').value,
                remarques: document.getElementById('form-remarques').value,
                status: 'absent'
            });
            closeModal('add'); e.target.reset(); renderDonneurs();
        }

        function editDonneur(id) {
            editingId = id; const d = donneurs.find(x => x.id === id);
            if (d) {
                document.getElementById('edit-nom').value = d.nom;
                document.getElementById('edit-tel').value = d.tel;
                document.getElementById('edit-creneau').value = d.creneau;
                document.getElementById('edit-numPrelevement').value = d.numPrelevement;
                document.getElementById('edit-ecole').value = d.ecole;
                document.getElementById('edit-filiere').value = d.filiere;
                document.getElementById('edit-remarques').value = d.remarques;
                openModal('edit');
            }
        }
        function saveDonneur(e) {
            e.preventDefault(); const d = donneurs.find(x => x.id === editingId);
            if (d) {
                d.nom = document.getElementById('edit-nom').value;
                d.tel = document.getElementById('edit-tel').value;
                d.creneau = document.getElementById('edit-creneau').value;
                d.numPrelevement = document.getElementById('edit-numPrelevement').value;
                d.ecole = document.getElementById('edit-ecole').value;
                d.filiere = document.getElementById('edit-filiere').value;
                d.remarques = document.getElementById('edit-remarques').value;
                closeModal('edit'); renderDonneurs();
            }
        }
        function deleteDonneur(id) { if(confirm('Supprimer ?')) { donneurs = donneurs.filter(d => d.id !== id); renderDonneurs(); } }

        // IMPORTS / EXPORTS
        function openModal(id) { document.getElementById('modal-'+id).classList.add('active'); }
        function closeModal(id) { document.getElementById('modal-'+id).classList.remove('active'); }

        function importExcel() {
            const file = document.getElementById('import-file').files[0];
            if (!file) return alert('S√©lectionnez un fichier');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workbook = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    let count = 0;
                    jsonData.forEach(row => {
                        let clean = {}; Object.keys(row).forEach(k => clean[k.trim()] = row[k]);
                        if(clean['Nom'] || clean['Nom Complet']) {
                            donneurs.push({
                                id: Math.max(...donneurs.map(d=>d.id),0)+1,
                                nom: clean['Nom']||clean['Nom Complet']||'Inconnu',
                                tel: clean['T√©l√©phone']||clean['Tel']||'',
                                creneau: clean['Cr√©neau']||'09h00 ‚Äì 10h00',
                                numPrelevement: '', ecole: 'ENSEM', filiere: '', remarques: '', status: 'absent'
                            });
                            count++;
                        }
                    });
                    alert(count + ' import√©s !'); closeModal('import'); document.getElementById('import-file').value='';
                    renderDonneurs(); renderSuivi(); renderStats();
                } catch(err) { alert('Erreur lecture fichier'); }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportJSON() {
            const blob = new Blob([JSON.stringify({donneurs, comite})], {type:'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = 'backup_donsang_'+Date.now()+'.json'; a.click(); closeModal('export');
        }

        function importJSONBackup(e) {
            const reader = new FileReader();
            reader.onload = function(ev) {
                try {
                    const d = JSON.parse(ev.target.result);
                    if(d.donneurs) donneurs = d.donneurs;
                    if(d.comite) comite = d.comite;
                    alert('Restauration r√©ussie !');
                    const act = document.querySelector('.tab-content.active').id;
                    if(act==='donneurs') renderDonneurs();
                    if(act==='comite') renderComite();
                    if(act==='suivi') renderSuivi();
                    if(act==='stats') renderStats();
                } catch(er) { alert('Fichier invalide'); }
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
        }
        
        function exportCSV() {
            const d = donneurs.filter(x => hasNum(x) && x.status === 'present' && x.ecole === 'ENSEM');
            const csv = ['Nom,Prelevement,Filiere', ...d.map(x => `${x.nom},${x.numPrelevement},${x.filiere}`)].join('\n');
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
            a.download = 'donneurs_ensem.csv'; a.click(); closeModal('export');
        }

        function exportPDF() {
            const tab = document.querySelector('.tab-content.active').id;
            let title="", sub="", head="", body="", count=0;
            
            if(tab === 'comite') {
                const list = comite.filter(c => c.present);
                title = "MEMBRES DU COMIT√â D'ORGANISATION"; sub = "Liste officielle des pr√©sents"; count = list.length;
                head = `<tr><th style="border:1px solid #ddd;padding:10px">Nom</th><th style="border:1px solid #ddd;padding:10px">R√¥le</th><th style="border:1px solid #ddd;padding:10px">Fili√®re</th></tr>`;
                body = list.map(c => `<tr><td style="border:1px solid #ddd;padding:10px">${c.nom}</td><td style="border:1px solid #ddd;padding:10px">${c.role}</td><td style="border:1px solid #ddd;padding:10px">${c.filiere||'-'}</td></tr>`).join('');
            } else if (tab === 'suivi') {
                const list = donneurs.filter(hasNum); 
                title = "FEUILLE DE POINTAGE"; sub = "√âtat des donneurs avec N¬∞ Pr√©l√®vement"; count = list.length;
                head = `<tr><th style="border:1px solid #ddd;padding:10px">N¬∞</th><th style="border:1px solid #ddd;padding:10px">Nom</th><th style="border:1px solid #ddd;padding:10px">√âtat</th></tr>`;
                body = list.sort((a,b)=>a.creneau.localeCompare(b.creneau)).map(d => `<tr><td style="border:1px solid #ddd;padding:10px">${d.numPrelevement}</td><td style="border:1px solid #ddd;padding:10px">${d.nom}</td><td style="border:1px solid #ddd;padding:10px;color:${d.status==='present'?'green':'red'}">${d.status.toUpperCase()}</td></tr>`).join('');
            } else {
                const list = donneurs.filter(d => hasNum(d) && d.status === 'present' && d.ecole === 'ENSEM');
                title = "RAPPORT DONNEURS ENSEM"; sub = "Confirm√©s avec pr√©l√®vement"; count = list.length;
                head = `<tr><th style="border:1px solid #ddd;padding:10px">Nom</th><th style="border:1px solid #ddd;padding:10px">N¬∞ Pr√©l√®vement</th><th style="border:1px solid #ddd;padding:10px">Fili√®re</th></tr>`;
                body = list.map(d => `<tr><td style="border:1px solid #ddd;padding:10px">${d.nom}</td><td style="border:1px solid #ddd;padding:10px">${d.numPrelevement}</td><td style="border:1px solid #ddd;padding:10px">${d.filiere}</td></tr>`).join('');
            }

            const el = document.createElement('div');
            el.innerHTML = `
                <div style="text-align:center;padding:20px;font-family:Arial;">
                    <h1 style="color:#3E2B5F;margin:0;">ENSEM ELKHIR</h1>
                    <h3 style="margin:5px 0;">${title}</h3>
                    <p>${sub}</p>
                    <p style="text-align:right">Total: ${count}</p>
                    <table style="width:100%;border-collapse:collapse;margin-top:20px;font-size:12px;">
                        <thead style="background:#3E2B5F;color:white;">${head}</thead><tbody>${body}</tbody>
                    </table>
                    <p style="margin-top:30px;font-size:10px;color:#999">G√©n√©r√© le ${new Date().toLocaleString()}</p>
                </div>`;
            
            html2pdf().set({ margin:10, filename:`export_${tab}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4'} }).from(el).save();
            closeModal('export');
        }

        renderDonneurs();
    </script>
</body>
</html>
